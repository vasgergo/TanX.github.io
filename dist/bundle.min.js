(()=>{"use strict";class t{constructor(t,e,i,s,h,a,n){switch(this.x=t,this.y=e,this.type=s,this.team=i,this.direction=h,this.context=n,this.img=a,this.width=void 0,this.height=void 0,this.health=void 0,this.fuel=void 0,this.consumption=void 0,this.damage=void 0,this.type){case"light":this.width=30,this.height=30,this.health=10,this.fuel=50,this.consumption=20,this.damage=10;break;case"medium":this.width=45,this.height=45,this.health=10,this.fuel=100,this.consumption=30,this.damage=30;break;case"heavy":this.width=60,this.height=60,this.health=10,this.fuel=150,this.consumption=40,this.damage=50}switch(this.aimParams={p1:70,p2:25},this.speed=0,this.type){case"light":this.speed=3;break;case"medium":this.speed=2;break;case"heavy":this.speed=1}switch(this.roationSpeed=0,this.type){case"light":this.roationSpeed=5;break;case"medium":this.roationSpeed=2;break;case"heavy":this.roationSpeed=1}switch(this.angle=0,this.direction){case"up":this.angle=0;break;case"right":this.angle=90;break;case"down":this.angle=180;break;case"left":this.angle=270}this.aimFunction,this.isCrashed=!1}rotationAnimation(t,e,i){if(this.angle=this.angle%360,this.angle===t)return void i();let s=(t-this.angle+360)%360>180?-1:1,h=setInterval((()=>{this.angle+=s*this.roationSpeed,this.angle=this.angle%360,this.angle<0&&(this.angle+=360),e(),console.log("destinationAngle: ",t),console.log("angle: ",this.angle),this.angle===t&&(console.log("clear"),clearInterval(h),i())}),20)}move(e,i,s,h,a,n){let r=0,o=0;if(this.fuel<=0)return void console.log("No fuel");switch(e){case"up":o=-1*this.speed;break;case"down":o=this.speed;break;case"left":r=-1*this.speed;break;case"right":r=this.speed}let l=new t(this.x+r,this.y+o,this.team,this.type,this.direction,this.img,this.context);if(l.x<0||l.x>n.width-l.width||l.y<0||l.y>n.height-l.height)console.log("Canvas");else{for(let t=0;t<h.length;t++)if(h[t].isOverlap(l)){this.health+=h[t].amount,h.splice(t,1);break}for(let t=0;t<a.length;t++)if(a[t].isOverlap(l)){this.fuel+=a[t].amount,a.splice(t,1);break}for(let t=0;t<i.length;t++)if(i[t].isOverlap(l))return void console.log("Fence");for(let t=0;t<s.length;t++)if(s[t]!==this&&s[t].isOverlap(l))return void console.log("overlapping with: ",s[t].team+" "+s[t].type);this.x+=r,this.y+=o,this.fuel-=this.consumption/100}}getDamage(t){this.health-=t,this.health<=0&&(this.health=0,document.getElementById(this.team+"_"+this.type).style.backgroundColor="red",this.isCrashed=!0)}isOverlap(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}draw(){let t=this.angle;this.context.save(),this.context.translate(this.x+this.img.width/2,this.y+this.img.height/2),this.context.rotate(t*Math.PI/180),this.context.drawImage(this.img,-this.img.width/2,-this.img.height/2),this.context.restore()}}class e{constructor(t){this.color=t,this.tanks=[],this.tankIndex=-1}addTank(t){this.tanks.push(t)}nextTank(){for(this.tankIndex++,this.tankIndex>=this.tanks.length&&(this.tankIndex=0);this.tanks[this.tankIndex].isCrashed;)console.log("Ncrashed"),this.tankIndex++,this.tankIndex>=this.tanks.length&&(this.tankIndex=0);return this.tanks[this.tankIndex]}}class i{static getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}}class s{static overlap(t,e){if(Array.isArray(e)){if(Array.isArray(e[0])){for(let i=0;i<e.length;i++)for(let s=0;s<e[i].length;s++)if(t.x<e[i][s].x+e[i][s].width&&t.x+t.width>e[i][s].x&&t.y<e[i][s].y+e[i][s].height&&t.y+t.height>e[i][s].y)return{isOverlap:!0,overlapWith:e[i][s]};return!1}for(let i=0;i<e.length;i++)if(t.x<e[i].x+e[i].width&&t.x+t.width>e[i].x&&t.y<e[i].y+e[i].height&&t.y+t.height>e[i].y)return{isOverlap:!0,overlapWith:e[i]};return!1}return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}}class h{static image;constructor(t,e,i,s){this.x=t,this.y=e,this.blockSzie=s,this.type=i,this.array=[],this.heightNum=void 0,this.widthNum=void 0,this.height=void 0,this.width=void 0,this.initWall(i)}initWall(t){let e=function(t){let e=[];switch(t){case"normal_x":e=[[1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1],[1,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1]];break;case"normal_y":e=[[1,1,1,1,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,1,1,1,1]];break;case"normal_round":e=[[0,0,0,0,1,0,0,0,0],[0,0,0,1,1,1,0,0,0],[0,0,1,1,1,1,1,0,0],[0,1,1,1,0,1,1,1,0],[1,1,1,0,0,0,1,1,1],[0,1,1,1,0,1,1,1,0],[0,0,1,1,1,1,1,0,0],[0,0,0,1,1,1,0,0,0],[0,0,0,0,1,0,0,0,0]];break;case"tank_trap":e=[[0,0,0,0,0,1,1,0,0,0,0,0],[0,1,1,0,0,1,1,0,0,1,1,0],[0,1,1,1,0,1,1,0,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,1,1,1,0,1,1,0,1,1,1,0],[0,1,1,0,0,1,1,0,0,1,1,0],[0,0,0,0,0,1,1,0,0,0,0,0]];break;default:console.log("No such type")}return e}(t);this.heightNum=e.length,this.widthNum=e[0].length,this.height=e.length*this.blockSzie,this.width=e[0].length*this.blockSzie;for(let t=0;t<this.heightNum;t++)for(let i=0;i<this.widthNum;i++)1===e[t][i]&&this.array.push({x:this.x+i*this.blockSzie,y:this.y+t*this.blockSzie,exist:e[t][i]})}static randomWalls(t,e){let a=[],n={normal_x:2,normal_y:3,normal_round:1,tank_trap:1};for(let r in n){let o=10;for(;n[r]>0&&!(o<0);){let l=i.getRandomInt(50,1e3),d=i.getRandomInt(50,450),c=new h(l,d,r,10,t);s.overlap(c,a).isOverlap||s.overlap(c,e).isOverlap||(a.push(c),n[r]--),o--}}return console.log(a),a}draw(t){for(const e in this.array)this.array[e].exist&&t.drawImage(h.image,this.array[e].x,this.array[e].y,this.blockSzie,this.blockSzie)}isCollide(t,e){if(t<this.x||t>this.x+this.width||e<this.y||e>this.y+this.height)return!1;for(let i=0;i<this.array.length;i++)if(this.array[i].exist&&t>this.array[i].x&&t<this.array[i].x+this.blockSzie&&e>this.array[i].y&&e<this.array[i].y+this.blockSzie)return!0}isOverlap(t){for(let e=0;e<this.array.length;e++)if(this.array[e].exist&&t.x<this.array[e].x+this.blockSzie&&t.x+t.img.width>this.array[e].x&&t.y<this.array[e].y+this.blockSzie&&t.y+t.img.height>this.array[e].y)return!0;return!1}demolish(t,e,i=40){let s,h;for(let a=0;a<this.array.length;a++)s=this.array[a].x+this.blockSzie/2,h=this.array[a].y+this.blockSzie/2,Math.sqrt((s-t)**2+(h-e)**2)<i&&(this.array[a].exist=!1)}}class a{static image;static ctx;constructor(t,e){this.x=t,this.y=e,this.width=30,this.height=30,this.amount=20}draw(){a.ctx.drawImage(a.image,this.x,this.y,this.width,this.height)}isOverlap(t){return t.x<this.x+this.width&&t.x+t.img.width>this.x&&t.y<this.y+this.height&&t.y+t.img.height>this.y}static randomHeal(t){let e,h=0,n=0,r=100,o=!0;for(;o&&r>0;){h=i.getRandomInt(50,1e3),n=i.getRandomInt(50,450),e=new a(h,n),o=!1;for(let i=0;i<t.length;i++)if(s.overlap(e,t[i]).isOverlap){o=!0;break}r--}return e}}class n{static image;static ctx;constructor(t,e){this.x=t,this.y=e,this.width=30,this.height=30,this.amount=50}draw(){n.ctx.drawImage(n.image,this.x,this.y,this.width,this.height)}isOverlap(t){return t.x<this.x+this.width&&t.x+t.img.width>this.x&&t.y<this.y+this.height&&t.y+t.img.height>this.y}static randomFuel(t){let e,h=0,a=0,r=100,o=!0;for(;o&&r>0;){h=i.getRandomInt(50,1e3),a=i.getRandomInt(50,450),e=new n(h,a),o=!1;for(let i=0;i<t.length;i++)if(s.overlap(e,t[i]).isOverlap){o=!0;break}r--}return e}}const r=["desert","red_heavy","red_light","red_medium","blue_heavy","blue_light","blue_medium","fence","red_cross","fuel","heal"];let o,l,d,c,g,m,u=1100,y=650,w=window.innerWidth,p=window.innerHeight,k=[],f=[],x=!1,v=[],b=[],I=0;const _=30,E=1e3;let T,A=[],S=[],P=[];function O(){let t,e;for(let i=0;i<v.length;i++)t=v[i].team,e=v[i].type,document.getElementById(t+"_"+e+"_health").innerText=v[i].health,document.getElementById(t+"_"+e+"_fuel").innerText=v[i].fuel.toFixed(1),document.getElementById(t+"_"+e+"_consumption").innerText=v[i].consumption,document.getElementById(t+"_"+e+"_damage").innerText=v[i].damage}function z(){I=_,g=g===d?c:d,m=g.nextTank(),console.log("->Active player is: "+g.color+" tank: "+m.type),O(),function(){let t;for(let e=0;e<v.length;e++)t=v[e]===m?"green":v[e].isCrashed?"red":"white",document.getElementById(v[e].team+"_"+v[e].type).style.backgroundColor=t}(),document.getElementById(m.team+"_"+m.type).style.backgroundColor="green","blue"===g.color?(document.getElementById("blueActiveTankImg").src=m.img.src,document.getElementById("redActiveTankImg").src=f.red_cross.src):(document.getElementById("redActiveTankImg").src=m.img.src,document.getElementById("blueActiveTankImg").src=f.red_cross.src),window.addEventListener("keypress",F),window.addEventListener("keydown",C),T=setInterval((()=>{window.document.getElementById("timer").innerText=I.toFixed(1),I<=.1&&(console.log("time is up"),clearInterval(T),B(),setTimeout((()=>{z()}),1e3)),I-=.1}),100),m.aimFunction=W,x=!0,A.push(a.randomHeal(P)),S.push(n.randomFuel(P)),L()}function B(){clearInterval(T),window.removeEventListener("keydown",C),window.removeEventListener("keypress",F)}function C(t){switch(t.key){case"w":m.move("up",b,v,A,S,l);break;case"s":m.move("down",b,v,A,S,l);break;case"a":m.move("left",b,v,A,S,l);break;case"d":m.move("right",b,v,A,S,l);break;case"ArrowUp":m.aimParams.p1+=1;break;case"ArrowDown":m.aimParams.p1-=1;break;case"ArrowLeft":m.aimParams.p2-=1;break;case"ArrowRight":m.aimParams.p2+=1;break;case"Enter":B(),function(t){let e,i,s,h,a;console.log("shoot!");let n,r,l=t.aimFunction,d=t.aimParams.p1,c=t.aimParams.p2;switch(t.angle){case 0:h=t.x+t.img.width/2,a=t.y,e=-1,i=1,s=!0;break;case 90:h=t.x+t.img.width,a=t.y+t.img.height/2,e=1,i=1,s=!1;break;case 180:h=t.x+t.img.width/2,a=t.y+t.img.height,e=1,i=1,s=!0;break;case 270:h=t.x,a=t.y+t.img.height/2,e=-1,i=-1,s=!1}let g,w=0,p=setInterval((()=>{o.drawImage(f.desert,0,0,u,y),v.forEach((t=>{t.draw()})),b.forEach((t=>{t.draw(o)})),S.forEach((t=>{t.draw()})),A.forEach((t=>{t.draw()})),o.beginPath(),o.lineWidth=2,o.moveTo(h,a);for(let t=0;t<w;t++){if(s?(n=h+i*l(t,d,c),r=a+e*t):(n=h+e*t,r=a+i*l(t,d,c)),g=N(n,r),g.bool)return o.lineTo(n,r),o.stroke(),o.closePath(),clearInterval(p),null!==g.tank&&g.tank.getDamage(m.damage),void setTimeout((()=>{z()}),E);for(let t=0;t<b.length;t++)if(b[t].isCollide(n,r))return b[t].demolish(n,r),o.lineTo(n,r),o.stroke(),o.closePath(),clearInterval(p),void setTimeout((()=>{z()}),E);o.lineTo(n,r)}o.stroke(),o.closePath(),w++}),1)}(m)}L()}function F(t){switch("8"!==t.key&&"6"!==t.key&&"2"!==t.key&&"4"!==t.key||(x=!1,window.removeEventListener("keypress",F),window.removeEventListener("keydown",C),console.log("key removed")),t.key){case"8":m.rotationAnimation(0,L,e);break;case"6":m.rotationAnimation(90,L,e);break;case"2":m.rotationAnimation(180,L,e);break;case"4":m.rotationAnimation(270,L,e)}function e(){I!==_&&(x=!0,L(),window.addEventListener("keypress",F),window.addEventListener("keydown",C))}}function L(){o.drawImage(f.desert,0,0,u,y),x&&function(t){let e,i,s,h,a,n=t.aimFunction,r=t.aimParams.p1,l=t.aimParams.p2;switch(m.angle){case 0:h=m.x+m.img.width/2,a=m.y,e=-1,i=1,s=!0;break;case 90:h=m.x+m.img.width,a=m.y+m.img.height/2,e=1,i=1,s=!1;break;case 180:h=m.x+m.img.width/2,a=m.y+m.img.height,e=1,i=1,s=!0;break;case 270:h=m.x,a=m.y+m.img.height/2,e=-1,i=-1,s=!1}o.beginPath(),o.strokeStyle="red",o.lineWidth=2,o.moveTo(h,a);let d,c,g=h,u=a,y=0;for(let t=0;y<500;t++)s?(d=h+i*n(t,r,l),c=a+e*t):(d=h+e*t,c=a+i*n(t,r,l)),y+=Math.sqrt(Math.pow(d-g,2)+Math.pow(c-u,2)),g=d,u=c,o.lineTo(d,c);o.stroke(),o.closePath()}(m),S.forEach((t=>{t.draw()})),A.forEach((t=>{t.draw()})),b.forEach((t=>{t.draw(o)})),v.forEach((t=>{t.draw()})),O()}function N(t,e){if(t<0||t>u||e<0||e>y)return console.log("wall collosion!"),{bool:!0,tank:null};for(let i=0;i<v.length;i++){let s=v[i];if(t>s.x&&t<s.x+s.img.width&&e>s.y&&e<s.y+s.img.height)return console.log("tankcollosion!"),{bool:!0,tank:s}}return!1}function W(t,e,i){return-Math.sin(t/i)*e}window.onload=function(){!function(){function i(t){return new Promise((e=>{let i=new Image;i.src="./pictures/"+t+".png",i.onload=()=>{f[t]=i,e()}}))}let s=[];for(let t=0;t<r.length;t++)s.push(i(r[t]));Promise.all(s).then((()=>{console.log("all images loaded"),function(){l=document.getElementById("myCanvas"),o=l.getContext("2d"),l.width=u,l.height=y,l.style.left=(w-u)/2-5+"px",l.style.top=(p-y)/2-5+"px",a.image=f.heal,n.image=f.fuel,h.image=f.fence,a.ctx=o,n.ctx=o,d=new e("red"),c=new e("blue"),k.push(c),k.push(d),c.addTank(new t(100,150,"blue","light","right",f.blue_light,o)),c.addTank(new t(110,300,"blue","medium","right",f.blue_medium,o)),c.addTank(new t(100,450,"blue","heavy","right",f.blue_heavy,o)),d.addTank(new t(930,150,"red","light","left",f.red_light,o)),d.addTank(new t(890,310,"red","medium","left",f.red_medium,o)),d.addTank(new t(950,430,"red","heavy","left",f.red_heavy,o)),k.forEach((t=>{t.tanks.forEach((t=>{v.push(t)}))}));let i=!1;P.push(b,A,S,v),i||(b.push(new h(350,100,"normal_y",10)),b.push(new h(350,400,"normal_y",10)),b.push(new h(700,100,"normal_y",10)),b.push(new h(700,400,"normal_y",10)),b.push(new h(480,250,"tank_trap",10)),A.push(new a(180,150)),A.push(new a(500,450)),A.push(new a(900,45)),S.push(new n(700,270)),S.push(new n(500,150)),console.log(P));i&&(P.push(v),b=h.randomWalls(f.fence,P),P.push(b),A.push(a.randomHeal(P)),S.push(n.randomFuel(P)));g=d,console.log("game started"),L(),z()}()}))}()}})();